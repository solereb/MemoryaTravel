<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è | Memorya</title>
    <style>
        :root {
            --admin-bg: #2c3e50;
            --admin-teal: #7DAFB0;
            --danger: #e74c3c;
            --success: #2ecc71;
            --text: #333;
            --gray: #f4f7f6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { display: flex; min-height: 100vh; background: var(--gray); }

        .sidebar { width: 250px; background: var(--admin-bg); color: white; padding: 20px 0; }
        .sidebar h2 { padding: 0 20px 20px; border-bottom: 1px solid #3e4f5f; font-size: 1.2rem; }
        .nav-item { padding: 15px 20px; cursor: pointer; transition: 0.3s; display: block; color: #bdc3c7; text-decoration: none; }
        .nav-item:hover, .nav-item.active { background: #34495e; color: white; }

        .main-content { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        h1 { margin-bottom: 30px; color: var(--text); }

        table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; color: var(--text-teal); font-weight: 600; }

        .badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-verified { background: #d4edda; color: #155724; }
        .badge-pending { background: #fff3cd; color: #856404; }

        .btn { padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; transition: 0.2s; margin-right: 5px; }
        .btn-confirm { background: var(--success); color: white; }
        .btn-delete { background: var(--danger); color: white; }
        .btn-reply { background: var(--admin-teal); color: white; }

        .ticket-row td { vertical-align: top; }
        .screenshot-preview { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 1px solid #ddd; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 4px solid var(--admin-teal); }
        .stat-card small { color: #888; text-transform: uppercase; font-size: 0.7rem; }
        .stat-card div { font-size: 1.5rem; font-weight: bold; margin-top: 5px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>Memorya Admin</h2>
    <div class="nav-item active" onclick="showTab('stats')">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
    <div class="nav-item" onclick="showTab('users')">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
    <div class="nav-item" onclick="showTab('tickets')">üì© –¢–∏–∫–µ—Ç—ã</div>
    <a href="/map.html" class="nav-item">‚¨Ö –ù–∞ –∫–∞—Ä—Ç—É</a>
</div>

<div class="main-content">
    
    <div id="stats" class="tab-content active">
        <h1>–û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã</h1>
        <div class="stats-grid">
            <div class="stat-card"><small>–í—Å–µ–≥–æ —é–∑–µ—Ä–æ–≤</small><div id="statUsers">0</div></div>
            <div class="stat-card"><small>–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏–π</small><div id="statTravels">0</div></div>
            <div class="stat-card"><small>–ê–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤</small><div id="statTickets">0</div></div>
        </div>
    </div>

    <div id="users" class="tab-content">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
        <table>
            <thead>
                <tr>
                    <th>Email</th>
                    <th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="usersTable">
                </tbody>
        </table>
    </div>

    <div id="tickets" class="tab-content">
        <h1>–¢–∏–∫–µ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏</h1>
        <table>
            <thead>
                <tr>
                    <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
                    <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                    <th>–°–æ–æ–±—â–µ–Ω–∏–µ</th>
                    <th>–°–∫—Ä–∏–Ω</th>
                    <th>–î–∞—Ç–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="ticketsTable">
                </tbody>
        </table>
    </div>
</div>
<script>
    const API_URL = `http://${window.location.hostname}:8000`;

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        
        if(tabId === 'users') loadUsers();
        if(tabId === 'tickets') loadTickets();
        if(tabId === 'stats') loadStats();
    }

    async function loadUsers() {
        const res = await fetch(`${API_URL}/admin/users`, { credentials: 'include' });
        const users = await res.json();
        const container = document.getElementById('usersTable');
        container.innerHTML = users.map(u => `
            <tr>
                <td>${u.email}</td>
                <td><span class="badge ${u.is_verified ? 'badge-verified' : 'badge-pending'}">
                    ${u.is_verified ? '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω' : '–û–∂–∏–¥–∞–µ—Ç'}</span>
                </td>
                <td>${new Date(u.created_at).toLocaleDateString()}</td>
                <td>
                    ${!u.is_verified ? `<button class="btn btn-confirm" onclick="verifyUser('${u.id}')">OK</button>` : ''}
                    <button class="btn btn-delete" onclick="deleteUser('${u.id}')">–£–¥–∞–ª–∏—Ç—å</button>
                </td>
            </tr>
        `).join('');
    }

    async function loadTickets() {
        const res = await fetch(`${API_URL}/admin/tickets`, { credentials: 'include' });
        const tickets = await res.json();
        const container = document.getElementById('ticketsTable');
        container.innerHTML = tickets.map(t => `
            <tr class="ticket-row">
                <td><span style="color: ${t.priority === 'high' ? 'red' : 'green'}">${t.priority.toUpperCase()}</span></td>
                <td><small>${t.user_email}</small></td>
                <td style="max-width: 300px;">${t.message}</td>
                <td>
                    <img src="${API_URL}/admin/support/${t.id}/${t.auth_id}/screenshot" class="screenshot-preview" onclick="window.open(this.src)">
                </td>
                <td>${new Date(t.created_at).toLocaleString()}</td>
                <td>
                    <button class="btn btn-reply" onclick="replyTicket('${t.user_email}')">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                    <button class="btn btn-delete" onclick="deleteTicket('${t.id}')">üóë</button>
                </td>
            </tr>
        `).join('');
    }

    async function verifyUser(id) {
        if(!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø–æ—á—Ç—É –≤—Ä—É—á–Ω—É—é?')) return;
        await fetch(`${API_URL}/admin/users/${id}/verify`, { method: 'POST', credentials: 'include' });
        loadUsers();
    }

    async function deleteUser(id) {
        if(!confirm('–£–î–ê–õ–ò–¢–¨ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø –ò –í–°–ï –ï–ì–û –î–ê–ù–ù–´–ï?')) return;
        await fetch(`${API_URL}/admin/users/${id}`, { method: 'DELETE', credentials: 'include' });
        loadUsers();
    }
    async function deleteTicket(id) {
        if(!confirm('–£–î–ê–õ–ò–¢–¨ –¢–ò–ö–ï–¢?')) return;
        await fetch(`${API_URL}/admin/ticket/${id}`, { method: 'DELETE', credentials: 'include' });
        loadTickets();
    }

    function replyTicket(email) {
        window.location.href = `mailto:${email}?subject=Memorya Support Response`;
    }

    async function loadStats() {const res = await fetch(`${API_URL}/admin/stat`, { credentials: 'include' });
        if (res.status === 403){
            window.location.href = '/403.html'
        }
        const s = await res.json();
        
        document.getElementById('statUsers').textContent = s.total_users;
        document.getElementById('statTravels').textContent = s.total_travels;
        document.getElementById('statTickets').textContent = s.active_tickets;
    }

    loadStats();
</script>
</body>
</html>